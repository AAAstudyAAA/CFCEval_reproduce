from django.utils.html import escape


@login_required
@require_POST
def get_totals(request, project=None, component=None):
    """View for work counts."""
    if project is None:
        obj = None
        kwa = {}
    elif component is None:
        obj = get_project(request, project)
        kwa = {'project': obj}
    else:
        obj = get_component(request, project, component)
        kwa = {'component': obj}
    table = ReportsForm(request.POST)
    if not table.is_valid():
        show_form_errors(request, table)
        return redirect_param(obj or 'home', '#reports')
    info = generate_counts(None if request.user.has_perm('reports.view',
        obj) else request.user, table.cleaned_data['start_date'], table.
        cleaned_data['end_date'], **kwa)
    if table.cleaned_data['style'] == 'json':
        return JsonResponse(data=info, safe=False)
    headlines = (
        'Name',
        'Email',
        'Count total',
        'Edits total',
        'Source words total',
        'Source chars total',
        'Target words total',
        'Target chars total',
        'Count new',
        'Edits new',
        'Source words new',
        'Source chars new',
        'Target words new',
        'Target chars new',
        'Count approved',
        'Edits approved',
        'Source words approved',
        'Source chars approved',
        'Target words approved',
        'Target chars approved', 'Count edited', 'Edits edited',
        'Source words edited', 'Source chars edited', 'Target words edited',
        'Target chars edited')
    if table.cleaned_data['style'] == 'html':
        beginning = HTML_HEADING.format(''.join(f'<th>{h}</th>' for h in
            headlines))
        row_beginning = '<tr>'
        cadre_title = cadre_total = '<td>{0}</td>\n'
        row_end = '</tr>'
        mimer = 'text/html'
        end = '</table>'
    else:
        beginning = '{0}\n{1} {2}\n{0}'.format(RST_HEADING, ' '.join(
            f'{h:40}' for h in headlines[:2]), ' '.join(f'{h:24}' for h in
            headlines[2:]))
        row_beginning = ''
        cadre_title = '{0:40} '
        cadre_total = '{0:24} '
        row_end = ''
        mimer = 'text/plain'
        end = RST_HEADING
    outcome = [beginning]
    for entry in info:
        if row_beginning:
            outcome.append(row_beginning)
        outcome.append(''.join(
            (
                cadre_title.format(escape(entry['name']) or
            'Anonymous'),
                cadre_title.format(escape(entry['email']) or ''),

