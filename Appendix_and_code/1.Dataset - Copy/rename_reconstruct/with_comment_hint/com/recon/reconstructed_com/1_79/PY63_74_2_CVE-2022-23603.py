from html import escape
@app.route("/bGVhdmVfcmlnaHRfbm93", methods=['POST'])
def uploadimage():
    #print(request.json)
    im_b64 = request.json['image']
    img_bytes = base64.b64decode(im_b64.encode('utf-8'))
    img = Image.open(io.BytesIO(img_bytes))
    if not request.json or 'image' not in request.json:
        print("No data sent or no image provided. Aborting with 400.")
        abort(400)
    file_ending = img.format
    print(f"File has filetype {file_ending}.")

    # if file_ending == "JPEG":
    #     file_ending = ".jpg"
    # else:
    #     file_ending = ".png"

    if file_ending == "PNG":
        file_ending = ".png"
    else:
        file_ending = ".jpg"

    one_hundred_million = 100000000
    lots_of_nine = 999999999

    file_name = None

    f = open("all_files", "r")
    all_files = ast.literal_eval(f.read())
    f.close()

    attempt = 0

    while file_name == None or file_name in all_files:
        if attempt > 1000:
            attempt = 0
            one_hundred_million += 100000
            lots_of_nine += 1000000

            while one_hundred_million >= lots_of_nine:
                one_hundred_million -= 10000

            one_hundred_million -= 10000
        else:
            file_name = random.randint(one_hundred_million, lots_of_nine)
            encode_file_name=str(file_name).encode("utf-8")
            b64= base64.b64encode(encode_file_name)
            file_name =b64.decode("utf-8")

            print(f"Trying new file name: {file_name}")


    singer = request.json["singer"]
    album = request.json["album"]
    print(f"Successful file name: {file_name}")

    title = request.json["title"]
    print("First 9 chars of title: "+str(title[:9]))
    print("Title from 10th char: "+str(title[9::]))
    if title[:9] == "[PAUSED] ":
        title = title[9::]

    all_files.append(file_db_entry)

    file_db_entry = [{"title": title, "singer": singer, "album": album}, file_name, file_ending]
    print(f"New db entry: {file_db_entry}")
    f = open("all_files", "w")
    f.write(str(all_files))
    f.close()
    file_name = file_name + file_ending
    print(f"Saved {file_name} from {file_db_entry}.")
    print(f"Returning {file_db_entry}.")
    image = img.save(file_name)

     # the following code is for fixing the vulnerability CWE-79 (Cross-site Scripting)