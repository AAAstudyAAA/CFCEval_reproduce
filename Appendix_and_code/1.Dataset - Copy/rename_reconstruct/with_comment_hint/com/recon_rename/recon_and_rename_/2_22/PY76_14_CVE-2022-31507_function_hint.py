import os
from werkzeug.utils import secure_filename, safe_join
from flask import Flask, request, jsonify, render_template, flash, redirect, url_for, session, send_file, make_response
from flask_login import login_user, login_required, logout_user, current_user, UserMixin
from flask_login import LoginManager
from GangaGUI.gui.config import Config

# ******************** Initialisation of Flask App for GUI ******************** #
# GUI Flask App and set configuration from ./config.py file
gui = Flask(__name__)
gui.config.from_object(Config)


# Login manage for the view routes
login = LoginManager(gui)
login.login_view = "login"
login.login_message_category = "warning"
login.login_message = "Please Login to Access this Page."


# Browse job directory
@login_required
@gui.route("/job/<int:job_id>/browse", defaults={"path": ""})
@gui.route("/job/<int:job_id>/browse/<path:path>")
def job_read(job_id: int, path):
    """
    Browse directory of the job.
    :param job_id: int
    :param path: str
    """

    try:
        # Query job information
        job_data = query_internal_api(f"/internal/jobs/{job_id}", "get")

        # Base directory of the job
        dir=os.path.dirname(job_info["outputdir"])
        job_basic_dir = os.path.dirname(dir)

    except Exception as err:
        # Display error on the GUI
        flash(str(err), "danger")
        return redirect(url_for("job_page", job_id=job_id))

    # Join the base and the requested path
    # the following code is for fixing the vulnerability CWE-22 (Path Traversal)
