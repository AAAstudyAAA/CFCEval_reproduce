import cherrypy
from rdiffweb.controller import Controller, flash
from rdiffweb.tools.i18n import ugettext as _




@cherrypy.expose
def users(self, username=None, criteria=u"", search=u"", action=u"", **kwargs):

    # If we're just showing the initial page, just do that
    if action == "edit":
        store=self.app.store
        account = store.get_user(username)
        if account:
            table = EditUserForm(obj=account)
            # if form.validate_on_submit():

            if not table.validate_on_submit():
                flash(table.error_message, level='error')
            else:
                try:
                    table.populate_obj(account)
                    flash(_("User information modified successfully."))
                except Exception as e:
                    flash(str(e), level='error')
        else:
            flash(_("Cannot edit user `%s`: user doesn't exists") % username, level='error')

    elif action == "add":
        table = UserForm()
        # if form.validate_on_submit():
        if not table.validate_on_submit():
            flash(table.error_message, level='error')
        else:
            try:
                store= self.app.store
                account =store.add_user(username)
                table.populate_obj(account)
                flash(_("User added successfully."))
            except Exception as e:
                flash(str(e), level='error')

    elif action == 'delete':
        table