import re
from typing import cast
from ..exceptions import RequestEntityTooLarge
from ..http import parse_options_header




# Multipart line breaks MUST be CRLF (\r\n) by RFC-7578, except that
# many implementations break this and either use CR or LF alone.
BLANK_LINE_RE = re.compile(b"(?:\r\n\r\n|\r\r|\n\n)", re.MULTILINE)

# This must be long enough to contain any line breaks plus any
# additional boundary markers (--) such that they will be found in a
# subsequent search
SEARCH_EXTRA_LENGTH = 8




def next_event(self) -> Event:
    event: Event = NEED_DATA

    if self.state == State.PREAMBLE:
        match = self.preamble_re.search(self.buffer, self._search_position)
    elif self.state == State.PART:
        if match is not None:
            filename = extra.get("filename")
            name = cast(str, extra.get("name"))
            # if filename is not None:
            if filename is None:
                event = Field(
                    headers=headers,
                    name=name,
                )
            else:
                event = File(
                filename=filename,
                headers=headers,
                name=name, )

            self._search_position = 0
            self.state = State.DATA

            self