from django.utils.html import escape


@login_required
@require_POST
def get_cites(request, project=None, component=None):
    """View for credits."""
    if project is None:
        obj = None
        kwa = {'translation__isnull': False}
    elif component is None:
        obj = get_project(request, project)
        kwa = {'translation__component__project': obj}
    else:
        obj = get_component(request, project, component)
        kwa = {'translation__component': obj}
    table = ReportsForm(request.POST)
    if not table.is_valid():
        show_form_errors(request, table)
        return redirect_param(obj or 'home', '#reports')
    info = generate_credits(None if request.user.has_perm('reports.view',
        obj) else request.user, table.cleaned_data['start_date'], table.
        cleaned_data['end_date'], **kwa)
    if table.cleaned_data['style'] == 'json':
        return JsonResponse(data=info, safe=False)
    if table.cleaned_data['style'] == 'html':
        beginning = '<table>'
        row_beginning = '<tr>'
        lyric_media = '<th>{0}</th>'
        transliterator_beginning = '<td><ul>'
        transliterator_media = '<li><a href="mailto:{0}">{1}</a> ({2})</li>'
        transliterator_end = '</ul></td>'
        row_end = '</tr>'
        mimer = 'text/html'
        end = '</table>'
    else:
        beginning = ''
        row_beginning = ''
        lyric_media = '* {0}\n'
        transliterator_beginning = ''
        transliterator_media = '    * {1} <{0}> ({2})'
        transliterator_end = ''
        row_end = ''
        mimer = 'text/plain'
        end = ''
    outcome = [beginning]
    for lyric in info:
        title, transliterators = lyric.popitem()
        outcome.append(row_beginning)
        # the following code is for fixing the vulnerability CWE-79 (Cross-site Scripting)