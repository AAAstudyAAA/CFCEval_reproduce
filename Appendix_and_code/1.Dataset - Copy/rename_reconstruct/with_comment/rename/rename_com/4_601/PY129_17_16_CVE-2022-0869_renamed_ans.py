from django.utils import timezone
from django.shortcuts import render, get_object_or_404
from django.contrib import messages
from spirit.core.utils.http import safe_redirect
from spirit.core.utils.views import is_post
from spirit.core.utils.decorators import moderator_required
from spirit.comment.models import Comment
from spirit.topic.models import Topic


@moderator_required
def medium(request, pk, field_name, to_value, action=None, message=None):
    subject = get_object_or_404(Topic, pk=pk)
    if is_post(request):
        total =(
            Topic.objects.
            filter(pk=pk).
            exclude(**{field_name: to_value}).
            update(**{field_name: to_value,
                      'reindex_at': timezone.now()}))
        if total and action is not None:
            Comment.create_moderation_action(
                user=request.user,
                topic=subject, action=action)
        if message is not None:
            messages.info(request, message)
        # the following code is for fixing the vulnerability CWE-601 (Open Redirect)

