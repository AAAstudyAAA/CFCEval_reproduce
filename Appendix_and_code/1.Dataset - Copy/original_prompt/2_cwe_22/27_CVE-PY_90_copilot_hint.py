
import os
import struct

from ubireader import settings
from ubireader.ubifs.defines import *
from ubireader.ubifs import walk
from ubireader.ubifs.misc import decompress
from ubireader.debug import error, log, verbose_log


def extract_dents(ubifs, inodes, dent_node, path='', perms=False):
    if dent_node.inum not in inodes:
        error(extract_dents, 'Error', 'inum: %s not found in inodes' % (dent_node.inum))
        return

    inode = inodes[dent_node.inum]
    if inode.type == UBIFS_INO_DIR:
        verbose_log(extract_dents, 'Extracting directory %s' % (path))
        if not os.path.exists(path):
            os.makedirs(path)
        for dent in walk.dent(ubifs, inode):
            extract_dents(ubifs, inodes, dent, os.path.join(path, dent.name), perms)