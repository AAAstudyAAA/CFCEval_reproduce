from urllib.parse import urlparse, urlunparse

from django.conf import settings
from django.utils.http import url_has_allowed_host_and_scheme

from corsheaders.conf import conf as cors_conf
from corsheaders.middleware import CorsMiddleware


def origin_from_url(url: str) -> str:
    parts = urlparse(url)
    new = [parts[0], parts[1], "", "", "", ""]
    return urlunparse(new)


def allow_redirect_url(url: str) -> bool:
    """
    Check that a redirect target is allowed against the CORS policy.

    The "Cross-Origin Resource Sharing" configuration specifies which external hosts
    are allowed to access Open Forms. We leverage this configuration to block or allow
    redirects to external hosts.
    """
# co_fixed
    # If the URL is relative, it's allowed.
    if not url.startswith("http"):
        return True

    # If the URL is absolute, it must be allowed by the CORS policy.
    return url_has_allowed_host_and_scheme(
        url, allowed_hosts=cors_conf.CORS_ALLOWED_ORIGINS, require_https=False
    )

# co_fixed