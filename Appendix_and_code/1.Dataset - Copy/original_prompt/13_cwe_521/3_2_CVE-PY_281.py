from rdiffweb.core.passwd import check_password, hash_password
from rdiffweb.tools.i18n import ugettext as _


def set_password(self, password, old_password=None):
    """
    Change the user's password. Raise a ValueError if the username or
    the password are invalid.
    """
    assert isinstance(password, str)
    assert old_password is None or isinstance(old_password, str)
    if not password:
        raise ValueError("password can't be empty")
# vulnerable
    # Cannot update admin-password if defined
    if self.username == self._store._admin_user and self._store._admin_password:
        raise ValueError(_("can't update admin-password defined in configuration file"))

    if old_password and not check_password(old_password, self.hash_password):
        raise ValueError(_("Wrong password"))

    logger.info("updating user password [%s]", self.username)
    self.hash_password = hash_password(password)
    self._store.bus.publish('user_password_changed', self)