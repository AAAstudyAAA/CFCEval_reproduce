import cherrypy

from rdiffweb.controller import flash
from rdiffweb.tools.i18n import gettext_lazy as _

# Maximum number of password change attempt before logout
CHANGE_PASSWORD_MAX_ATTEMPT = 5
CHANGE_PASSWORD_ATTEMPTS = 'change_password_attempts'


@cherrypy.expose
def default(self, **kwargs):
    # Process the parameters.
    profile_form = UserProfileForm(obj=self.app.currentuser)
    password_form = UserPasswordForm()
    refresh_form = RefreshForm()
    if profile_form.is_submitted():
        if profile_form.validate():
 # vulnerable
            profile_form.populate_obj(self.app.currentuser)
 # vulnerable
            flash(_("Profile updated successfully."), level='success')
        else:
            flash(profile_form.error_message, level='error')
    elif password_form.is_submitted():
        if password_form.validate():
            password_form.populate_obj(self.app.currentuser)
        else:
            flash(password_form.error_message, level='error')
    elif refresh_form.is_submitted():
        if refresh_form.validate():
            refresh_form.populate_obj(self.app.currentuser)
        else:
            flash(refresh_form.error_message, level='error')
    params = {
        'profile_form': profile_form,
        'password_form': password_form,
        'refresh_form': refresh_form,
    }