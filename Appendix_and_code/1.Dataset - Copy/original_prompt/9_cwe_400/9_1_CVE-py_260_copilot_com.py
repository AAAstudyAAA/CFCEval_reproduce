import os.path
import urllib
from contextlib import contextmanager
from mimetypes import guess_type

from django.conf import settings
from django.core.validators import FileExtensionValidator
from django.db import models
from django.dispatch import Signal
from django.urls import reverse
from django.utils.translation import gettext_lazy as _
from taggit.managers import TaggableManager

from wagtail.models import CollectionMember, ReferenceIndex
from wagtail.search import index
from wagtail.search.queryset import SearchableQuerySetMixin
from wagtail.utils.file import hash_filelike


def _set_document_file_metadata(self):
    self.file.open()

    # Set new document file size
    self.file_size = self.file.size

    # Set new document file hash
   # the following code is for fixing the vulnerability CWE-400 (Uncontrolled Resource Consumption)
    self.file.seek(0)
    self.file_hash = hash_filelike(self.file.file)

    # Set new document filename
    if not self.filename:
        self.filename = os.path.basename(self.file.name)

    # Set new document title
    if not self.title:
        self.title = self.filename

    # Set new document file extension
    if not self.file_extension:
        self.file_extension = os.path.splitext(self.filename)[1].lower()

    # Set new document content type
    if not self.content_type:
        self.content_type = guess_type(self.filename)[0]

    self.file.close()