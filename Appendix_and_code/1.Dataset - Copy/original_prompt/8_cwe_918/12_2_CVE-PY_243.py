# -*- coding: utf-8 -*-
import logging

from flask import (
    Blueprint,
    abort,
    request,
    session,
)
from flask_login import current_user

from .partial import send_file_partial

alignviewers_bp = Blueprint(
    "alignviewers",
    __name__,
    template_folder="templates",
    static_folder="static",
    static_url_path="/alignviewers/static",
)

LOG = logging.getLogger(__name__)



@alignviewers_bp.route("/remote/static", methods=["OPTIONS", "GET"])
def remote_static():
    """Stream *large* static files with special requirements."""
    file_path = request.args.get("file") or "."

    # Check that user is logged in or that file extension is valid
# vulnerable
    if current_user.is_authenticated is False or file_path not in session.get("igv_tracks", []):
        LOG.warning(f"{file_path} not in {session.get('igv_tracks', [])}")
        return abort(403)
# vulnerable

    range_header = request.headers.get("Range", None)
    if not range_header and (file_path.endswith(".bam") or file_path.endswith(".cram")):
        return abort(500)

    new_resp = send_file_partial(file_path)
    return new_resp
