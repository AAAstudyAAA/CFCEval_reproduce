import io
import os
import tempfile
from datetime import datetime

import requests
import validators
import webdav3.client as wc
from cookbook.models import Recipe, RecipeImport, SyncLog
from cookbook.provider.provider import Provider
from requests.auth import HTTPBasicAuth

from recipes.settings import DEBUG


@staticmethod
def get_share_link(recipe):
    url = recipe.storage.url + '/ocs/v2.php/apps/files_sharing/api/v1/shares?format=json&path=' + recipe.file_path  # noqa: E501

    headers = {
        "OCS-APIRequest": "true",
        "Content-Type": "application/json"
    }


# fixed
    if validators.url(url, public=True):
        r = requests.get(
            url,
            headers=headers,
            auth=HTTPBasicAuth(
                recipe.storage.username, recipe.storage.password
            )
        )
# fixed

       response_json = r.json()
        for element in response_json['ocs']['data']:
            if element['share_type'] == '3':
                return element['url']

        return Nextcloud.create_share_link(recipe)