from tcms.core.templatetags.extra_filters import bleach_input
def diff_objects(old_instance, new_instance, fields):
    """
    Diff two objects by examining the given fields and
    return a string.
    """
    full_diff = []

    for field in fields:
        field_diff = []
        old_value = getattr(old_instance, field.attname)
        new_value = getattr(new_instance, field.attname)
        # ---fixed---
        # clean stored XSS
        if isinstance(old_value, str):
            old_value = bleach_input(old_value)
        if isinstance(new_value, str):
            new_value = bleach_input(new_value)
        # ---fixed---

        for line in difflib.unified_diff(
                str(old_value).split("\n"),
                str(new_value).split("\n"),
                fromfile=field.attname,
                tofile=field.attname,
                lineterm="",
        ):
            field_diff.append(line)
        full_diff.extend(field_diff)

    return "\n".join(full_diff)