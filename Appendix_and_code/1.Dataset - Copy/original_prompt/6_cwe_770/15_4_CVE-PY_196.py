import logging

import cherrypy
from wtforms.fields import BooleanField, PasswordField, StringField, SubmitField
from wtforms.validators import InputRequired, Length

from rdiffweb.controller import Controller, flash
from rdiffweb.controller.form import CherryForm
from rdiffweb.tools.auth_form import LOGIN_PERSISTENT, SESSION_KEY
from rdiffweb.tools.i18n import gettext_lazy as _

# Define the logger
logger = logging.getLogger(__name__)


@cherrypy.expose()
@cherrypy.tools.auth_mfa(on=False)
# vulnerable
@cherrypy.tools.ratelimit()
# vulnerable
def index(self, **kwargs):
    """
    Called by auth_form to generate the /login/ page.
    """
    form = LoginForm()

    # Validate user's credentials
    if form.validate_on_submit():
        try:
            results = [r for r in cherrypy.engine.publish('login', form.login.data, form.password.data) if r]
        except Exception:
            logger.exception('fail to validate user [%s] credentials', form.login.data)
            flash(_("Failed to validate user credentials."), level='error')
        else:
            if len(results) > 0 and results[0]:
                cherrypy.tools.auth_form.login(username=results[0].username, persistent=form.persistent.data)
                cherrypy.tools.auth_form.redirect_to_original_url()
            else:
                flash(_("Invalid username or password."))
    params = {
        'form': form,
    }
    # Add welcome message to params. Try to load translated message.
    welcome_msg = self.app.cfg.welcome_msg