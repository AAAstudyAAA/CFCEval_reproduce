import os
import re
import time
from html import escape
from urllib.parse import quote_plus as urlquote
import sqlite3 as sql
from hashlib import sha256
import asyncio
import mimetypes
from aiohttp import web, ClientSession
from kenny2automate.utils import DummyCtx
from kenny2automate.i18n import LANG, i18n

DISCORD_API = 'https://discordapp.com/api/v6'
LANG = {i: i18n(i, 'qqq') for i in LANG}
ONE_YEAR = 31557600
GLOBAL_GAMES = [
    'Go Fish', 'Connect 4',
    'Fight', 'Boggle', 'Uno',
    'Blackjack', 'Set', 'Chess',
    '007', 'Big Two'
]



async def save_server(self, request):
    await self.elg(request)
    guild = self.bot.get_guild(int(request.match_info.get('server', '0')))
    if guild is None:
        self.notfound()
    if not guild.get_member(
            int(self.getsesh(request)['client']['id'])
    ).guild_permissions.administrator:
        self.notfound()
    data = await request.post()
    params = []
    otherparams = {}
    for k in data.keys():
        if not k.startswith('channel-'):
            otherparams[k] = ','.join(data.getall(k))
            continue
        param = {'channel_id': int(k[len('channel-'):])}
        for v in data.getall(k):
            v = v.partition('=')
            if v[0] == 'ping':
                if 'ping' not in param:
                    param['ping'] = set()
                param['ping'].add(v[-1])
            else:
                param[v[0]] = v[-1] or None
        param['ping'] = '|'.join(param.get('ping', ())) or None
        params.append(param)
    otherparams['guild_id'] = guild.id
    # coge
    otherparams['user_id'] = self.getsesh(request)['client']['id']
# coge