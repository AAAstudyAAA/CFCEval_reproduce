import os
from werkzeug.utils import secure_filename, safe_join
from flask import Flask, request, jsonify, render_template, flash, redirect, url_for, session, send_file, make_response
from flask_login import login_user, login_required, logout_user, current_user, UserMixin
from flask_login import LoginManager
from GangaGUI.gui.config import Config
gui = Flask(__name__)
gui.config.from_object(Config)
login = LoginManager(gui)
login.login_view = 'login'
login.login_message = 'Please Login to Access this Page.'
login.login_message_category = 'warning'


@gui.route('/job/<int:job_id>/browse', defaults={'path': ''})
@gui.route('/job/<int:job_id>/browse/<path:path>')
@login_required
def job_read(job_id: int, path):
    """
    Browse directory of the job.
    :param job_id: int
    :param path: str
    """
    try:
        job_data = query_internal_api(f'/internal/jobs/{job_id}', 'get')
        job_basic_dir = os.path.dirname(os.path.dirname(job_data['outputdir']))
    except Exception as err:
        flash(str(err), 'danger')
        return redirect(url_for('job_page', job_id=job_id))
    abs_dir = safe_join(job_basic_dir, path)
    return_dir = os.path.dirname(abs_dir).replace(job_basic_dir, '')
    if not os.path.exists(abs_dir):
        flash('Directory for this job does not exist.', 'warning')
        return redirect(url_for('job_page', job_id=job_id))
