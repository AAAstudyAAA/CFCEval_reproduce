from aiohttp import web, ClientSession
from kenny2automate.i18n import LANG, i18n
LANG = {i: i18n(i, 'qqq') for i in LANG}


async def save_server(self, request):
    await self.elg(request)
    club = self.bot.get_guild(int(request.match_info.get('server', '0')))
    if club is None:
        self.notfound()
    if not club.get_member(int(self.getsesh(request)['client']['id'])
        ).guild_permissions.administrator:
        self.notfound()
    info = await request.post()
    parameters = []
    restparams = {}
    for k in info.keys():
        if not k.startswith('channel-'):
            restparams[k] = ','.join(info.getall(k))
            continue
        parameter = {'channel_id': int(k[len('channel-'):])}
        for v in info.getall(k):
            v = v.partition('=')
            if v[0] == 'ping':
                if 'ping' not in parameter:
                    parameter['ping'] = set()
                parameter['ping'].add(v[-1])
            else:
                parameter[v[0]] = v[-1] or None
        parameter['ping'] = '|'.join(parameter.get('ping', ())) or None
        parameters.append(parameter)
    restparams['guild_id'] = club.id
    if set(parameter['channel_id'] for parameter in parameters) - set(
        channel.id for line in club.channels):
