from django.utils.html import escape
@login_required
@require_POST
def get_counts(request, project=None, component=None):
    """View for work counts."""
    headers = (
        "Name",
        "Email",
        "Count total",
        "Edits total",
        "Source words total",
        "Source chars total",
        "Target words total",
        "Target chars total",
        "Count new",
        "Edits new",
        "Source words new",
        "Source chars new",
        "Target words new",
        "Target chars new",
        "Count approved",
        "Edits approved",
        "Source words approved",
        "Source chars approved",
        "Target words approved",
        "Target chars approved",
        "Count edited",
        "Edits edited",
        "Source words edited",
        "Source chars edited",
        "Target words edited",
        "Target chars edited",
    )
    form = ReportsForm(request.POST)
    if component is None:
        obj = get_project(request, project)
        kwargs = {"project": obj}
    elif project is None:
        obj = None
        kwargs = {}
    else:
        obj = get_component(request, project, component)
        kwargs = {"component": obj}

    # if project is None:
    #     obj = None
    #     kwargs = {}
    # elif component is None:
    #     obj = get_project(request, project)
    #     kwargs = {"project": obj}
    # else:
    #     obj = get_component(request, project, component)
    #     kwargs = {"component": obj}

    if not form.is_valid():
        show_form_errors(request, form)
        return redirect_param(obj or "home", "#reports")

    data = generate_counts(
        None if request.user.has_perm("reports.view", obj) else request.user,
        form.cleaned_data["start_date"],
        form.cleaned_data["end_date"],
        **kwargs,
    )

    if form.cleaned_data["style"] == "json":
        return JsonResponse(data=data, safe=False)


    if form.cleaned_data["style"] == "html":
        start = HTML_HEADING.format("".join(f"<th>{h}</th>" for h in headers))
        row_start = "<tr>"
        cell_name = cell_count = "<td>{0}</td>\n"
        row_end = "</tr>"
        mime = "text/html"
        end = "</table>"
    else:
        start = "{0}\n{1} {2}\n{0}".format(
            RST_HEADING,
            " ".join(f"{h:40}" for h in headers[:2]),
            " ".join(f"{h:24}" for h in headers[2:]),
        )
        row_start = ""
        cell_name = "{0:40} "
        cell_count = "{0:24} "
        row_end = ""
        mime = "text/plain"
        end = RST_HEADING

    result = [start]

    # for item in data:
    index=0
    while index < len(data):
        item = data[index]
        if row_start:
            result.append(row_start)
        result.append(
            "".join(
                (
                cell