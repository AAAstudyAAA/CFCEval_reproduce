from html import escape


@app.route('/bGVhdmVfcmlnaHRfbm93', methods=['POST'])
def upload():
    if not request.json or 'image' not in request.json:
        print('No data sent or no image provided. Aborting with 400.')
        abort(400)
    im_b64 = request.json['image']
    img_bytes = base64.b64decode(im_b64.encode('utf-8'))
    img = Image.open(io.BytesIO(img_bytes))
    doc_suffix = img.format
    print(f'File has filetype {doc_suffix}.')
    if doc_suffix == 'JPEG':
        doc_suffix = '.jpg'
    else:
        doc_suffix = '.png'
    million= 100000000
    nines = 999999999
    doc_title = None
    f = open('all_files', 'r')
    all_docs = ast.literal_eval(f.read())
    f.close()
    try = 0
    while doc_title == None or doc_title in all_docs:
        if try <= 1000:
            doc_title = random.randint(one_C_meg, lotss_of_9)
            doc_title = base64.b64encode(str(doc_title).encode('utf-8')
                ).decode('utf-8')
            print(f'Trying new file name: {doc_title}')
        else:
            try = 0
            million += 100000
            nines += 1000000
            while million>= nines:
                million -= 10000
            million -= 10000
    print(f'Successful file name: {doc_title}')
    name = request.json['title']
    print('First 9 chars of title: ' + str(name[:9]))
    print('Title from 10th char: ' + str(name[9:]))
    if name[:9] == '[PAUSED] ':
        name = name[9:]
    musician = request.json['singer']
    collection = request.json['album']
    doc_db_item = [{'title': name, 'singer': musician, 'album': collection},
        doc_title, doc_suffix]
    print(f'New db entry: {doc_db_item}')
    all_docs.append(doc_db_item)
    f = open('all_files', 'w')
    f.write(str(all_docs))
    f.close()
    doc_title = doc_title + doc_suffix
    img = img.save(doc_title)
    print(f'Saved {doc_title} from {doc_db_item}.')
    print(f'Returning {doc_db_item}.')
    return escape({'entry': doc_db_item})
