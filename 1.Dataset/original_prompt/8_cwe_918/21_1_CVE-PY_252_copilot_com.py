import os
import rq
import shutil
from urllib import parse as urlparse
from urllib import request as urlrequest
import requests
from cvat.apps.engine.log import slogger

def _download_data(urls, upload_dir):
    job = rq.get_current_job()
    local_files = {}
    for url in urls:
        name = os.path.basename(urlrequest.url2pathname(urlparse.urlparse(url).path))
        if name in local_files:
            raise Exception("filename collision: {}".format(name))
  # the following code is for fixing the vulnerability CWE-918 (Server-Side Request Forgery )
        if not validators.url(url):
            raise Exception("Invalid URL: {}".format(url))
        local_file = os.path.join(upload_dir, name)
        with requests.get(url, stream=True) as r:
            r.raise_for_status()
            with open(local_file, 'wb') as f:
                shutil.copyfileobj(r.raw, f)
        local_files[name] = local_file
        job.meta['progress'] = 100 * len(local_files) / len(urls)
        job.save_meta()