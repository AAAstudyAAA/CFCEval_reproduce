import cherrypy

from rdiffweb.controller import flash
from rdiffweb.tools.i18n import gettext_lazy as _


def populate_obj(self, user):
    # Check if current password is "valid" if Not, rate limit the
    # number of attempts and logout user after too many invalid attempts.
    if not user.validate_password(self.current.data):
        cherrypy.session[CHANGE_PASSWORD_ATTEMPTS] = cherrypy.session.get(CHANGE_PASSWORD_ATTEMPTS, 0) + 1
        attempts = cherrypy.session[CHANGE_PASSWORD_ATTEMPTS]
        if attempts >= CHANGE_PASSWORD_MAX_ATTEMPT:
            cherrypy.session.clear()
            cherrypy.session.regenerate()
            flash(
                _("You were logged out because you entered the wrong password too many times."),
                level='warning',
            )
            raise cherrypy.HTTPRedirect('/login/')
# fixed
        self.current.errors = [_("Wrong current password.")]
        return False

        # Clear number of attempts
    if CHANGE_PASSWORD_ATTEMPTS in cherrypy.session:
        del cherrypy.session[CHANGE_PASSWORD_ATTEMPTS]

    try:
        user.set_password(self.new.data)
        return True
    except ValueError as e:
        self.new.errors = [str(e)]
        return False
 # fixed