"""Core API v2 views."""

import logging
from drf_spectacular.utils import extend_schema
from rest_framework import permissions, response, status
from rest_framework.views import APIView
from modoboa.core.utils import check_for_updates
from modoboa.lib.permissions import IsSuperUser
from modoboa.lib.throttle import (
    UserLesserDdosUser, LoginThrottle, PasswordResetApplyThrottle,
    PasswordResetRequestThrottle, PasswordResetTotpThrottle
)

from . import serializers

logger = logging.getLogger("modoboa.auth")




class ComponentsInformationAPIView(APIView):
    """Retrieve information about installed components."""
    # CO
        permission_classes = [permissions.IsAuthenticated]
    
        @extend_schema(
            responses=serializers.ComponentsInformationSerializer
        )
        def get(self, request):
            """Return information about installed components."""
            return response.Response(
                serializers.ComponentsInformationSerializer({
                    "updates": check_for_updates(request.user),
                    "throttles": {
                        "login": LoginThrottle().get_rate(),
                        "password_reset_request": PasswordResetRequestThrottle().get_rate(),
                        "password_reset_apply": PasswordResetApplyThrottle().get_rate(),
                        "password_reset_totp": PasswordResetTotpThrottle().get_rate(),
                        "user_lesser_ddos": UserLesserDdosUser().get_rate(),
                    }
                }).data
            )
# CO