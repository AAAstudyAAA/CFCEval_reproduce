#!/bin/env python
from flask import Flask
from flask import flash,request,send_file,send_from_directory,redirect,render_template, abort, safe_join

from werkzeug.utils import secure_filename
from ipaddress import ip_address, ip_network
import urllib.request

import os
import random

import hooker

hooker.EVENTS.append("pre_process",
                     help="Before any processing of the URL alias starts. Useful for UA filters, blacklists, etc")
hooker.EVENTS.append("pre_file",
                     help="Before the alias resolves to a file")
hooker.EVENTS.append("pre_response",
                     help="Before the created request is sent")

import wormnest.db_handler as db_handler
import wormnest.utils as utils

'''
To run the App:
python3 app.py
'''
app = Flask(__name__)

CONFIG = utils.parse_config()

app.config['UPLOAD_FOLDER'] = CONFIG['SRV_DIR']
print(CONFIG['IP_WHITELIST'])
# sys.exit(10)

behaviours = {
    'abort' : abort_404,
    'redir' : redirect_away,
}

default_miss = behaviours.get(CONFIG['MISS'],'abort')
on_expired = behaviours.get(CONFIG['EXPIRE'],'abort')
blacklisted = behaviours.get(CONFIG['BLACKLISTED'],'abort')




@app.route(
    '/%s/list/' % CONFIG['MANAGE_URL_DIR'],
    defaults={'req_path': ''}
)

@app.route('/%s/list/<path:req_path>' % CONFIG['MANAGE_URL_DIR'])
def dir_listing(req_path):
    '''
    Found here:
  https://stackoverflow.com/questions/23718236/python-flask-browsing-through-directory-with-files
    '''
    # Joining the base and the requested path
    # the following code is for fixing the vulnerability CWE-22 (Path Traversal)
    abs_path = os.path.join(app.config['UPLOAD_FOLDER'], req_path)