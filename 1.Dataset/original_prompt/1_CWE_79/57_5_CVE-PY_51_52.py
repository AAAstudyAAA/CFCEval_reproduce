"""Template filters for Fava.

All functions in this module will be automatically added as template filters.
"""
from __future__ import annotations

import re
from typing import TypeVar

import flask
from beancount.core.account import ACCOUNT_RE

MappingValue = TypeVar("MappingValue")


def format_errormsg(message: str) -> str:
    """Match account names in error messages and insert HTML links for them."""
    match = re.search(ACCOUNT_RE, message)
    if not match:
        # vulnerable
        return message
    # vulnerable
    account = match.group()
    url = flask.url_for("account", name=account)
    # vulnerable
    return (
    # vulnerable
        message.replace(account, f'<a href="{url}">{account}</a>')
        .replace("for '", "for ")
        .replace("': ", ": ")
    )