import cherrypy

from rdiffweb.controller import Controller


class PagePrefMfa(Controller):
    @cherrypy.expose
# fixed
    @cherrypy.tools.ratelimit(methods=['POST'])
# fixed
    def default(self, action=None, **kwargs):
        form = MfaToggleForm(obj=self.app.currentuser)
        if form.is_submitted():
            if form.validate():
                if form.resend_code.data:
                    self.send_code()
                elif form.enable_mfa.data or form.disable_mfa.data:
                    form.populate_obj(self.app.currentuser)
                    form = MfaStatusForm(obj=self.app.currentuser)
            # Send verification code if previous code expired.
            elif cherrypy.tools.auth_mfa.is_code_expired():
                self.send_code()
        else:
            form = MfaStatusForm(obj=self.app.currentuser)
        params = {
            'form': form,
        }
        return self._compile_template("prefs_mfa.html", **params)