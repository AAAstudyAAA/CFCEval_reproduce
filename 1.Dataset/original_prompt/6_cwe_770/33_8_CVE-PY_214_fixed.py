import typing as t
from itertools import chain
from typing import Union
from .datastructures import MultiDict
from .sansio.multipart import Field
from .sansio.multipart import File
from .sansio.multipart import MultipartDecoder
from .wsgi import _make_chunk_iter

def parse(
        self, stream: t.IO[bytes], boundary: bytes, content_length: t.Optional[int]
) -> t.Tuple[MultiDict, MultiDict]:
    container: t.Union[t.IO[bytes], t.List[bytes]]
    _write: t.Callable[[bytes], t.Any]

    iterator = chain(
        _make_chunk_iter(
            stream,
            limit=content_length,
            buffer_size=self.buffer_size,
        ),
        [None],
    )
# fixed
    parser = MultipartDecoder(
        boundary, self.max_form_memory_size, max_parts=self.max_form_parts
    )
# fixed
    fields = []
    files = []

    current_part: Union[Field, File]
    for data in iterator:
        parser.receive_data(data)
        event = parser.next_event()