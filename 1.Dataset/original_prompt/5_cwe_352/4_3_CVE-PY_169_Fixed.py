import logging
import cherrypy
from rdiffweb.controller import Controller, flash
from rdiffweb.tools.i18n import ugettext as _

# Define the logger
logger = logging.getLogger(__name__)
@cherrypy.expose
def users(self, username=None, criteria=u"", search=u"", action=u"", **kwargs):
    # If we're just showing the initial page, just do that
    if action == "add":
        form = UserForm()
        if form.validate_on_submit():
            try:
                user = self.app.store.add_user(username)
                form.populate_obj(user)
                flash(_("User added successfully."))
            except Exception as e:
                flash(str(e), level='error')
        else:
            flash(form.error_message, level='error')
    elif action == "edit":
        user = self.app.store.get_user(username)
        if user:
            form = EditUserForm(obj=user)
            if form.validate_on_submit():
                try:
                    form.populate_obj(user)
                    flash(_("User information modified successfully."))
                except Exception as e:
                    flash(str(e), level='error')
            else:
                flash(form.error_message, level='error')
        else:
            flash(_("Cannot edit user `%s`: user doesn't exists") % username, level='error')
    elif action == 'delete':
# fixed
        form = DeleteUserForm()
        if form.validate_on_submit():
            self._delete_user(action, form)
# fixed
    params = {
        "add_form": UserForm(formdata=None),
        "edit_form": EditUserForm(formdata=None),
        "criteria": criteria,
        "search": search,
        "users": list(self.app.store.users(search=search, criteria=criteria)),
    }

    # Build users page
    return self._compile_template("admin_users.html", **params)