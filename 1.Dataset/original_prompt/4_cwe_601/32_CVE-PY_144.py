from archivy import app, forms
from archivy.helpers import get_db
from archivy.models import User
from flask import (
    render_template,
    flash,
    redirect,
    request,
)
from flask_login import login_user
from tinydb import Query
from werkzeug.security import check_password_hash


@app.route("/login", methods=["GET", "POST"])
def login():
    form = forms.UserForm()
    if form.validate_on_submit():
        db = get_db()
        user = db.search(
            (Query().username == form.username.data) & (Query().type == "user")
        )

        if user and check_password_hash(user[0]["hashed_password"], form.password.data):
            user = User.from_db(user[0])
            login_user(user, remember=True)
            flash("Login successful!", "success")

            next_url = request.args.get("next")
#vulnerable
            return redirect(next_url or "/")
# vulnerable
        flash("Invalid credentials", "error")
        return redirect("/login")
    return render_template("users/login.html", form=form, title="Login")

