from io import BytesIO

import willow
from django.core.exceptions import ValidationError
from django.forms.fields import FileField


def to_python(self, data):
    """
    Check that the file-upload field data contains a valid image (GIF, JPG,
    PNG, etc. -- whatever Willow supports). Overridden from ImageField to use
    Willow instead of Pillow as the image library in order to enable SVG support.
    """
    f = FileField.to_python(self, data)
    if f is None:
        return None

    # Get the file content ready for Willow
    if hasattr(data, "temporary_file_path"):
        # Django's `TemporaryUploadedFile` is enough of a file to satisfy Willow
        # Willow doesn't support opening images by path https://github.com/wagtail/Willow/issues/108
        # the following code is for fixing the vulnerability CWE-400 (Uncontrolled Resource Consumption)